{% extends "business_partners/vendor_base.html" %}
{% load static %}

{% block title %}Update Inventory - {{ part.material_description }} - {{ block.super }}{% endblock %}

{% block vendor_content %}
<div class="vendor-inventory-update">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'business_partners:vendor_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'business_partners:vendor_inventory_list' %}">Inventory</a></li>
            <li class="breadcrumb-item"><a href="{% url 'business_partners:vendor_inventory_detail' part.id %}">{{ part.material_description|truncatewords:3 }}</a></li>
            <li class="breadcrumb-item active">Update Inventory</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Update Inventory for {{ part.material_description }}</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Current Status Alert -->
                        <div class="alert {% if part.quantity == 0 %}alert-danger{% elif part.quantity <= 10 %}alert-warning{% else %}alert-success{% endif %}" role="alert">
                            <h6 class="alert-heading">Current Inventory Status</h6>
                            <p class="mb-0">
                                <strong>Current Stock:</strong> {{ part.quantity }} units
                                {% if part.quantity == 0 %}
                                    - <strong>OUT OF STOCK</strong>
                                {% elif part.quantity <= 10 %}
                                    - <strong>LOW STOCK</strong>
                                {% elif part.safety_stock and part.quantity < part.safety_stock %}
                                    - <strong>BELOW SAFETY LEVEL</strong>
                                {% else %}
                                    - In Stock
                                {% endif %}
                            </p>
                        </div>

                        <!-- Form Fields -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.stock.id_for_label }}" class="form-label">
                                        Current Stock Level <span class="text-danger">*</span>
                                    </label>
                                    {{ form.stock }}
                                    <div class="form-text">The current quantity available in stock.</div>
                                    {% if form.stock.errors %}
                                        <div class="text-danger small">{{ form.stock.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.reorder_level.id_for_label }}" class="form-label">
                                        Reorder Level <span class="text-danger">*</span>
                                    </label>
                                    {{ form.reorder_level }}
                                    <div class="form-text">Minimum stock level before reordering.</div>
                                    {% if form.reorder_level.errors %}
                                        <div class="text-danger small">{{ form.reorder_level.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.max_stock_level.id_for_label }}" class="form-label">
                                        Maximum Stock Level
                                    </label>
                                    {{ form.max_stock_level }}
                                    <div class="form-text">Maximum stock level for this item (optional).</div>
                                    {% if form.max_stock_level.errors %}
                                        <div class="text-danger small">{{ form.max_stock_level.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.supplier.id_for_label }}" class="form-label">
                                        Supplier
                                    </label>
                                    {{ form.supplier }}
                                    <div class="form-text">Primary supplier for this item.</div>
                                    {% if form.supplier.errors %}
                                        <div class="text-danger small">{{ form.supplier.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                Notes
                            </label>
                            {{ form.notes }}
                            <div class="form-text">Additional notes about this inventory item.</div>
                            {% if form.notes.errors %}
                                <div class="text-danger small">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Hidden fields -->
                        {{ form.part }}
                        {{ form.last_restock_date }}

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'business_partners:vendor_inventory_detail' part.id %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Part Summary Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Part Summary</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Part Number:</strong><br>
                        {{ part.parts_number }}
                    </div>
                    <div class="mb-3">
                        <strong>Description:</strong><br>
                        {{ part.material_description }}
                    </div>
                    <div class="mb-3">
                        <strong>Category:</strong><br>
                        {{ part.category.name|default:"N/A" }}
                    </div>
                    <div class="mb-3">
                        <strong>Brand:</strong><br>
                        {{ part.brand.name|default:"N/A" }}
                    </div>
                    <div class="mb-3">
                        <strong>Unit Price:</strong><br>
                        ${{ part.price|floatformat:2 }}
                    </div>
                    {% if part.safety_stock %}
                    <div class="mb-3">
                        <strong>Safety Stock:</strong><br>
                        {{ part.safety_stock }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'business_partners:vendor_inventory_detail' part.id %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                onclick="document.getElementById('quick-adjust-form').style.display='block'">
                            <i class="fas fa-adjust"></i> Quick Adjust
                        </a>
                        <a href="{% url 'business_partners:vendor_inventory_list' %}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Adjustment Form (Hidden by default) -->
            <div class="card" id="quick-adjust-form" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">Quick Stock Adjustment</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'business_partners:vendor_inventory_adjustment' part.id %}">
                        {% csrf_token %}
                        <div class="mb-2">
                            <label class="form-label">Adjustment Type</label>
                            <select class="form-select form-select-sm" name="adjustment_type" required>
                                <option value="">Select Type</option>
                                <option value="add">Add Stock</option>
                                <option value="remove">Remove Stock</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control form-control-sm" name="quantity" 
                                   min="1" required placeholder="Amount">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Reason</label>
                            <input type="text" class="form-control form-control-sm" name="reason" 
                                   placeholder="Optional reason">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-warning btn-sm">
                                <i class="fas fa-adjust"></i> Adjust
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Inventory Tips -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Inventory Management Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Keep reorder levels realistic based on demand</li>
                        <li>Monitor seasonal trends for stock adjustments</li>
                        <li>Set safety stock levels for critical items</li>
                        <li>Track supplier lead times accurately</li>
                        <li>Regular inventory audits prevent discrepancies</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-hide quick adjust form when clicking outside
    document.addEventListener('click', function(event) {
        const quickAdjustForm = document.getElementById('quick-adjust-form');
        const quickAdjustButton = event.target.closest('button[onclick*="quick-adjust-form"]');
        
        if (quickAdjustForm.style.display === 'block' && 
            !quickAdjustForm.contains(event.target) && 
            !quickAdjustButton) {
            quickAdjustForm.style.display = 'none';
        }
    });

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const stock = parseInt(document.getElementById('{{ form.stock.id_for_label }}').value);
        const reorderLevel = parseInt(document.getElementById('{{ form.reorder_level.id_for_label }}').value);
        
        if (reorderLevel < 0) {
            e.preventDefault();
            alert('Reorder level cannot be negative.');
            return;
        }
        
        if (stock < 0) {
            e.preventDefault();
            alert('Stock level cannot be negative.');
            return;
        }
    });
});
</script>

<style>
.vendor-inventory-update .card {
    transition: transform 0.2s;
}
.vendor-inventory-update .card:hover {
    transform: translateY(-2px);
}
.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
.alert {
    border-radius: 0.5rem;
}
</style>
{% endblock %}