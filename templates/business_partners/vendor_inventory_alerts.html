{% extends 'parts/base.html' %}
{% load static %}

{% block title %}Inventory Alerts - {{ vendor_profile.business_partner.company_name }}{% endblock %}

{% block extra_css %}
<style>
    .alerts-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .alerts-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .alerts-header h1 {
        margin-bottom: 10px;
        font-size: 2.5rem;
    }
    
    .alerts-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .alert-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .alert-section-header {
        padding: 20px 30px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .alert-section-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .alert-count {
        background: #e74c3c;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .alert-count.warning {
        background: #f39c12;
    }
    
    .alert-count.info {
        background: #3498db;
    }
    
    .parts-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .parts-table th,
    .parts-table td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .parts-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .parts-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .stock-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .stock-indicator.out-of-stock {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }
    
    .stock-indicator.low-stock {
        background: #fff3e0;
        color: #ef6c00;
        border: 1px solid #ffcc02;
    }
    
    .stock-indicator.below-safety {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
    }
    
    .part-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .part-sku {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .quantity-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .current-stock {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .stock-levels {
        font-size: 0.85rem;
        color: #7f8c8d;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2980b9;
    }
    
    .btn-warning {
        background: #f39c12;
        color: white;
    }
    
    .btn-warning:hover {
        background: #e67e22;
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 30px;
        color: #7f8c8d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .empty-state h4 {
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .summary-card i {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }
    
    .summary-card.danger i {
        color: #e74c3c;
    }
    
    .summary-card.warning i {
        color: #f39c12;
    }
    
    .summary-card.info i {
        color: #3498db;
    }
    
    .summary-card h3 {
        font-size: 2rem;
        margin-bottom: 5px;
        font-weight: 700;
    }
    
    .summary-card p {
        color: #7f8c8d;
        margin: 0;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .bulk-actions h5 {
        margin: 0;
        color: #2c3e50;
    }
    
    .filters {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }
    
    @media (max-width: 768px) {
        .alerts-container {
            padding: 10px;
        }
        
        .parts-table {
            font-size: 0.9rem;
        }
        
        .parts-table th,
        .parts-table td {
            padding: 10px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .bulk-actions {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .filters {
            flex-wrap: wrap;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="alerts-container">
    <div class="alerts-header">
        <h1><i class="fas fa-exclamation-triangle"></i> Inventory Alerts</h1>
        <p>Monitor and manage your stock levels to avoid stockouts</p>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card danger">
            <i class="fas fa-times-circle"></i>
            <h3>{{ out_of_stock.count }}</h3>
            <p>Out of Stock</p>
        </div>
        <div class="summary-card warning">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>{{ low_stock.count }}</h3>
            <p>Low Stock</p>
        </div>
        <div class="summary-card info">
            <i class="fas fa-shield-alt"></i>
            <h3>{{ below_safety_stock.count }}</h3>
            <p>Below Safety Stock</p>
        </div>
    </div>
    
    <!-- Out of Stock Section -->
    {% if out_of_stock %}
    <div class="alert-section">
        <div class="alert-section-header">
            <h3>
                <i class="fas fa-times-circle text-danger"></i>
                Out of Stock Parts
                <span class="alert-count">{{ out_of_stock.count }}</span>
            </h3>
            <div class="action-buttons">
                <button class="btn btn-warning btn-sm" onclick="bulkReorder('out-of-stock')">
                    <i class="fas fa-shopping-cart"></i> Bulk Reorder
                </button>
            </div>
        </div>
        <table class="parts-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-out-of-stock"></th>
                    <th>Part Details</th>
                    <th>Current Stock</th>
                    <th>Safety Stock</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for part in out_of_stock %}
                <tr>
                    <td><input type="checkbox" name="part_ids" value="{{ part.id }}" class="out-of-stock-checkbox"></td>
                    <td>
                        <div class="part-name">{{ part.name }}</div>
                        <div class="part-sku">SKU: {{ part.sku }}</div>
                    </td>
                    <td>
                        <div class="quantity-info">
                            <span class="current-stock text-danger">0</span>
                            <span class="stock-indicator out-of-stock">
                                <i class="fas fa-times"></i> Out of Stock
                            </span>
                        </div>
                    </td>
                    <td>{{ part.safety_stock|default:"Not set" }}</td>
                    <td>{{ part.updated_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'business_partners:vendor_part_edit' part.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Restock
                            </a>
                            <a href="{% url 'business_partners:vendor_part_detail' part.id %}" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Low Stock Section -->
    {% if low_stock %}
    <div class="alert-section">
        <div class="alert-section-header">
            <h3>
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Low Stock Parts
                <span class="alert-count warning">{{ low_stock.count }}</span>
            </h3>
            <div class="action-buttons">
                <button class="btn btn-warning btn-sm" onclick="bulkReorder('low-stock')">
                    <i class="fas fa-shopping-cart"></i> Bulk Reorder
                </button>
            </div>
        </div>
        <table class="parts-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-low-stock"></th>
                    <th>Part Details</th>
                    <th>Current Stock</th>
                    <th>Reorder Level</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for part in low_stock %}
                <tr>
                    <td><input type="checkbox" name="part_ids" value="{{ part.id }}" class="low-stock-checkbox"></td>
                    <td>
                        <div class="part-name">{{ part.name }}</div>
                        <div class="part-sku">SKU: {{ part.sku }}</div>
                    </td>
                    <td>
                        <div class="quantity-info">
                            <span class="current-stock text-warning">{{ part.quantity }}</span>
                            <span class="stock-indicator low-stock">
                                <i class="fas fa-exclamation-triangle"></i> Low Stock
                            </span>
                        </div>
                    </td>
                    <td>{{ part.reorder_level|default:"10" }}</td>
                    <td>{{ part.updated_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'business_partners:vendor_part_edit' part.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Restock
                            </a>
                            <a href="{% url 'business_partners:vendor_part_detail' part.id %}" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Below Safety Stock Section -->
    {% if below_safety_stock %}
    <div class="alert-section">
        <div class="alert-section-header">
            <h3>
                <i class="fas fa-shield-alt text-info"></i>
                Below Safety Stock
                <span class="alert-count info">{{ below_safety_stock.count }}</span>
            </h3>
            <div class="action-buttons">
                <button class="btn btn-warning btn-sm" onclick="bulkReorder('below-safety')">
                    <i class="fas fa-shopping-cart"></i> Bulk Reorder
                </button>
            </div>
        </div>
        <table class="parts-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-below-safety"></th>
                    <th>Part Details</th>
                    <th>Current Stock</th>
                    <th>Safety Stock</th>
                    <th>Difference</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for part in below_safety_stock %}
                <tr>
                    <td><input type="checkbox" name="part_ids" value="{{ part.id }}" class="below-safety-checkbox"></td>
                    <td>
                        <div class="part-name">{{ part.name }}</div>
                        <div class="part-sku">SKU: {{ part.sku }}</div>
                    </td>
                    <td>
                        <div class="quantity-info">
                            <span class="current-stock text-info">{{ part.quantity }}</span>
                            <span class="stock-indicator below-safety">
                                <i class="fas fa-shield-alt"></i> Below Safety
                            </span>
                        </div>
                    </td>
                    <td>{{ part.safety_stock }}</td>
                    <td class="text-danger">-{{ part.safety_stock|add:part.quantity|add:"-"|add:part.quantity }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'business_partners:vendor_part_edit' part.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Restock
                            </a>
                            <a href="{% url 'business_partners:vendor_part_detail' part.id %}" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Empty State -->
    {% if not out_of_stock and not low_stock and not below_safety_stock %}
    <div class="alert-section">
        <div class="empty-state">
            <i class="fas fa-check-circle text-success"></i>
            <h4>All Good!</h4>
            <p>No inventory alerts at this time. All your parts are well-stocked.</p>
            <a href="{% url 'business_partners:vendor_parts_list' %}" class="btn btn-primary">
                <i class="fas fa-boxes"></i> View All Parts
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div class="text-center" style="margin-top: 30px;">
        <a href="{% url 'business_partners:vendor_dashboard' %}" class="btn btn-success">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{% url 'business_partners:vendor_parts_list' %}" class="btn btn-primary">
            <i class="fas fa-boxes"></i> View All Parts
        </a>
        <a href="{% url 'business_partners:vendor_parts_import' %}" class="btn btn-warning">
            <i class="fas fa-upload"></i> Import Parts
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all functionality
    const selectAllCheckboxes = document.querySelectorAll('[id^="select-all-"]');
    
    selectAllCheckboxes.forEach(selectAll => {
        const category = selectAll.id.replace('select-all-', '');
        const checkboxes = document.querySelectorAll(`.${category}-checkbox`);
        
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // Update select all when individual checkboxes change
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll(`.${category}-checkbox:checked`).length;
                selectAll.checked = checkedCount === checkboxes.length;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
            });
        });
    });
});

function bulkReorder(category) {
    const checkboxes = document.querySelectorAll(`.${category}-checkbox:checked`);
    
    if (checkboxes.length === 0) {
        alert('Please select at least one part to reorder.');
        return;
    }
    
    const partIds = Array.from(checkboxes).map(cb => cb.value);
    const partNames = Array.from(checkboxes).map(cb => {
        const row = cb.closest('tr');
        return row.querySelector('.part-name').textContent;
    });
    
    if (confirm(`Are you sure you want to create reorder notifications for ${partIds.length} parts?\n\nParts:\n${partNames.slice(0, 5).join('\n')}${partNames.length > 5 ? '\n... and ' + (partNames.length - 5) + ' more' : ''}`)) {
        // Here you would typically send an AJAX request to create reorder notifications
        // For now, we'll just show a success message
        alert(`Reorder notifications created for ${partIds.length} parts. Check your email for details.`);
        
        // Optionally redirect to a reorder management page
        // window.location.href = '/vendor/reorders/';
    }
}

// Auto-refresh alerts every 5 minutes
setInterval(function() {
    // Only refresh if the page is visible
    if (!document.hidden) {
        window.location.reload();
    }
}, 300000); // 5 minutes
</script>
{% endblock %}