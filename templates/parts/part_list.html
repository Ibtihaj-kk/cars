{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Auto Parts - CarPortal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/parts.css' %}">
<style>
.parts-container {
    max-width: 1400px;
    margin: 100px auto;
    padding: 20px;
}

.filters-sidebar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    margin-bottom: 20px;
}

.filter-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.filter-section:last-child {
    border-bottom: none;
}

.filter-title {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
}

.filter-section .form-check {
    margin-bottom: 8px;
}

.filter-section .form-check-label {
    font-size: 14px;
    color: #495057;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.filter-section .form-check-label small {
    font-size: 12px;
}

.quick-price-ranges .btn {
    font-size: 11px;
    padding: 4px 8px;
}

.filter-count-badge {
    font-size: 10px;
    padding: 2px 6px;
}

/* Loading state for filters */
.filter-loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Smooth transitions */
.filter-section, .form-check, .btn {
    transition: all 0.2s ease;
}

.form-check:hover {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 2px 4px;
    margin: 2px -4px;
}

.price-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* HTMX Loading Indicator */
.htmx-indicator {
    display: none;
}

.htmx-request .htmx-indicator {
    display: block;
}

.htmx-request #parts-results {
    opacity: 0.6;
}

.price-inputs input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.parts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.part-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}

.part-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.part-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: #f8f9fa;
}

.part-content {
    padding: 20px;
}

.part-title {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    line-height: 1.4;
}

.part-category {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.part-price {
    font-size: 18px;
    font-weight: 700;
    color: #e74c3c;
    margin-bottom: 15px;
}

.part-actions {
    display: flex;
    gap: 10px;
}

.btn-cart {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary-custom {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.btn-primary-custom:hover {
    background: linear-gradient(135deg, #2980b9, #1f5f8b);
    transform: translateY(-1px);
}

.btn-secondary-custom {
    background: #ecf0f1;
    color: #2c3e50;
    border: 1px solid #bdc3c7;
}

.btn-secondary-custom:hover {
    background: #d5dbdb;
}

.stock-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.in-stock {
    background: #2ecc71;
    color: white;
}

.out-of-stock {
    background: #e74c3c;
    color: white;
}

.low-stock {
    background: #f39c12;
    color: white;
}

.sale-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #e74c3c;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
}

.search-sort-bar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.no-parts {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.pagination-custom {
    margin-top: 40px;
    display: flex;
    justify-content: center;
}

@media (max-width: 768px) {
    .parts-container {
        padding: 10px;
    }
    
    .parts-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .search-sort-bar {
        padding: 15px;
    }
    
    .price-inputs {
        flex-direction: column;
        gap: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="parts-container">
    <!-- Search Bar Only -->


    <!-- Note: Vehicle Compatibility Filter -->
    <!-- TODO: Vehicle compatibility filter is not yet implemented in the Part model. -->
    <!-- The vehicle models exist in the vehicles app, but there's no relationship -->
    <!-- established between Part and VehicleModel/VehicleSpecification yet. -->
    <!-- This feature requires adding a ManyToManyField or similar relationship -->
    <!-- to the Part model to link parts with compatible vehicles. -->

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3">
            <div class="filters-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="filter-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                
                <form method="GET" id="filterForm" 
                      hx-get="{% url 'parts:part_list' %}" 
                      hx-target="#parts-results" 
                      hx-trigger="change, submit"
                      hx-indicator="#loading-indicator">
                    {% csrf_token %}
                    <!-- Preserve search and sort -->
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    {% if request.GET.sort %}
                        <input type="hidden" name="sort" value="{{ request.GET.sort }}">
                    {% endif %}
                    
                    <!-- Categories -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-tags me-2"></i>Categories
                        </div>
                        {% for category in categories %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="categories" 
                                       value="{{ category.id }}" id="cat{{ category.id }}"
                                       {% if category.id|stringformat:"s" in request.GET.categories %}checked{% endif %}>
                                <label class="form-check-label" for="cat{{ category.id }}">
                                    {{ category.name }}
                                    <small class="text-muted">({{ category.part_count }})</small>
                                </label>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Brands -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-industry me-2"></i>Brands
                        </div>
                        {% for brand in brands %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="brands" 
                                       value="{{ brand.id }}" id="brand{{ brand.id }}"
                                       {% if brand.id|stringformat:"s" in request.GET.brands %}checked{% endif %}>
                                <label class="form-check-label" for="brand{{ brand.id }}">
                                    {{ brand.name }}
                                    <small class="text-muted">({{ brand.part_count }})</small>
                                </label>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- SKU Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-barcode me-2"></i>SKU
                        </div>
                        <input type="text" class="form-control form-control-sm" name="sku" 
                               value="{{ request.GET.sku }}" placeholder="Enter SKU..."
                               hx-get="{% url 'parts:part_list' %}"
                               hx-target="#parts-results"
                               hx-trigger="keyup changed delay:500ms"
                               hx-indicator="#loading-indicator"
                               hx-include="#filterForm">
                    </div>

                    <!-- Part Number Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-hashtag me-2"></i>Part Number
                        </div>
                        <input type="text" class="form-control form-control-sm" name="parts_number" 
                               value="{{ request.GET.parts_number }}" placeholder="Enter part number..."
                               hx-get="{% url 'parts:part_list' %}"
                               hx-target="#parts-results"
                               hx-trigger="keyup changed delay:500ms"
                               hx-indicator="#loading-indicator"
                               hx-include="#filterForm">
                    </div>

                    <!-- Sort By Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-sort me-2"></i>Sort By
                        </div>
                        <select class="form-select form-select-sm" name="sort"
                                hx-get="{% url 'parts:part_list' %}"
                                hx-target="#parts-results"
                                hx-trigger="change"
                                hx-indicator="#loading-indicator"
                                hx-include="#filterForm">
                            <option value="-created_at" {% if request.GET.sort == "-created_at" %}selected{% endif %}>Newest First</option>
                            <option value="created_at" {% if request.GET.sort == "created_at" %}selected{% endif %}>Oldest First</option>
                            <option value="price" {% if request.GET.sort == "price" %}selected{% endif %}>Price: Low to High</option>
                            <option value="-price" {% if request.GET.sort == "-price" %}selected{% endif %}>Price: High to Low</option>
                            <option value="name" {% if request.GET.sort == "name" %}selected{% endif %}>Name A-Z</option>
                            <option value="-name" {% if request.GET.sort == "-name" %}selected{% endif %}>Name Z-A</option>
                        </select>
                    </div>

                    <!-- Vehicle Make Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-car me-2"></i>Vehicle Make
                        </div>
                        {% for make in vehicle_makes %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vehicle_make" 
                                       value="{{ make.id }}" id="vehicle_make_{{ forloop.counter }}"
                                       {% if make.id|stringformat:"s" in request.GET.vehicle_make %}checked{% endif %}
                                       hx-get="{% url 'parts:part_list' %}"
                                       hx-target="#parts-results"
                                       hx-trigger="change"
                                       hx-indicator="#loading-indicator"
                                       hx-include="#filterForm">
                                <label class="form-check-label" for="vehicle_make_{{ forloop.counter }}">
                                    {{ make.name }} ({{ make.count }})
                                </label>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No vehicle makes available</p>
                        {% endfor %}
                    </div>

                    <!-- Vehicle Model Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-car-side me-2"></i>Vehicle Model
                        </div>
                        {% for model in vehicle_models %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vehicle_model" 
                                       value="{{ model.id }}" id="vehicle_model_{{ forloop.counter }}"
                                       {% if model.id|stringformat:"s" in request.GET.vehicle_model %}checked{% endif %}
                                       hx-get="{% url 'parts:part_list' %}"
                                       hx-target="#parts-results"
                                       hx-trigger="change"
                                       hx-indicator="#loading-indicator"
                                       hx-include="#filterForm">
                                <label class="form-check-label" for="vehicle_model_{{ forloop.counter }}">
                                    {{ model.make.name }} {{ model.name }} ({{ model.count }})
                                </label>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No vehicle models available</p>
                        {% endfor %}
                    </div>

                    <!-- Vehicle Variant Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-cogs me-2"></i>Vehicle Variant
                        </div>
                        {% for variant in vehicle_variants %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vehicle_variant" 
                                       value="{{ variant.id }}" id="vehicle_variant_{{ forloop.counter }}"
                                       {% if variant.id|stringformat:"s" in request.GET.vehicle_variant %}checked{% endif %}
                                       hx-get="{% url 'parts:part_list' %}"
                                       hx-target="#parts-results"
                                       hx-trigger="change"
                                       hx-indicator="#loading-indicator"
                                       hx-include="#filterForm">
                                <label class="form-check-label" for="vehicle_variant_{{ forloop.counter }}">
                                    {{ variant.model.make.name }} {{ variant.model.name }} {{ variant.name }} ({{ variant.year }}) ({{ variant.count }})
                                </label>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No vehicle variants available</p>
                        {% endfor %}
                    </div>
                    
                    <!-- Price Range -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-dollar-sign me-2"></i>Price Range
                        </div>
                        <div class="price-inputs">
                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="min_price" placeholder="Min" 
                                       value="{{ request.GET.min_price }}" min="0" step="0.01">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="max_price" placeholder="Max" 
                                       value="{{ request.GET.max_price }}" min="0" step="0.01">
                            </div>
                        </div>
                        <!-- Quick Price Ranges -->
                        <div class="quick-price-ranges mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1 mb-1" 
                                    onclick="setPriceRange(0, 50)">$0-$50</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1 mb-1" 
                                    onclick="setPriceRange(50, 100)">$50-$100</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1 mb-1" 
                                    onclick="setPriceRange(100, 500)">$100-$500</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary mb-1" 
                                    onclick="setPriceRange(500, null)">$500+</button>
                        </div>
                    </div>

                    <!-- Stock Status -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-boxes me-2"></i>Availability
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="in_stock" value="true" 
                                   id="inStock" {% if request.GET.in_stock == "true" %}checked{% endif %}>
                            <label class="form-check-label" for="inStock">
                                <i class="fas fa-check-circle text-success me-1"></i>In Stock Only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="low_stock" value="true" 
                                   id="lowStock" {% if request.GET.low_stock == "true" %}checked{% endif %}>
                            <label class="form-check-label" for="lowStock">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>Low Stock
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="featured" value="true" 
                                   id="featured" {% if request.GET.featured == "true" %}checked{% endif %}>
                            <label class="form-check-label" for="featured">
                                <i class="fas fa-star text-warning me-1"></i>Featured Only
                            </label>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-star me-2"></i>Minimum Rating
                        </div>
                        <select class="form-select form-select-sm" name="min_rating">
                            <option value="">Any Rating</option>
                            <option value="4" {% if request.GET.min_rating == "4" %}selected{% endif %}>
                                4+ Stars
                            </option>
                            <option value="3" {% if request.GET.min_rating == "3" %}selected{% endif %}>
                                3+ Stars
                            </option>
                            <option value="2" {% if request.GET.min_rating == "2" %}selected{% endif %}>
                                2+ Stars
                            </option>
                        </select>
                    </div>

                    <!-- ==================== NEW MATERIAL-RELATED FILTERS ==================== -->
                    
                    <!-- Material Type Filter -->
                    {% if material_types %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-cogs me-2"></i>Material Type
                        </div>
                        {% for material in material_types %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="material_types" 
                                   value="{{ material.material_type }}" id="material_type_{{ forloop.counter }}"
                                   {% if material.material_type in request.GET.material_types %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="material_type_{{ forloop.counter }}">
                                {{ material.material_type }} ({{ material.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Plant Filter -->
                    {% if plants %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-industry me-2"></i>Plant
                        </div>
                        {% for plant in plants %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="plants" 
                                   value="{{ plant.plant }}" id="plant_{{ forloop.counter }}"
                                   {% if plant.plant in request.GET.plants %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="plant_{{ forloop.counter }}">
                                {{ plant.plant }} ({{ plant.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Storage Location Filter -->
                    {% if storage_locations %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-warehouse me-2"></i>Storage Location
                        </div>
                        {% for location in storage_locations %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="storage_locations" 
                                   value="{{ location.storage_location }}" id="storage_location_{{ forloop.counter }}"
                                   {% if location.storage_location in request.GET.storage_locations %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="storage_location_{{ forloop.counter }}">
                                {{ location.storage_location }} ({{ location.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Material Group Filter -->
                    {% if material_groups %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-layer-group me-2"></i>Material Group
                        </div>
                        {% for group in material_groups %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="material_groups" 
                                   value="{{ group.material_group }}" id="material_group_{{ forloop.counter }}"
                                   {% if group.material_group in request.GET.material_groups %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="material_group_{{ forloop.counter }}">
                                {{ group.material_group }} ({{ group.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Division Filter -->
                    {% if divisions %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-sitemap me-2"></i>Division
                        </div>
                        {% for division in divisions %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="divisions" 
                                   value="{{ division.division }}" id="division_{{ forloop.counter }}"
                                   {% if division.division in request.GET.divisions %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="division_{{ forloop.counter }}">
                                {{ division.division }} ({{ division.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- ABC Indicator Filter -->
                    {% if abc_indicators %}
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-sort-alpha-down me-2"></i>ABC Indicator
                        </div>
                        {% for indicator in abc_indicators %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="abc_indicators" 
                                   value="{{ indicator.abc_indicator }}" id="abc_indicator_{{ forloop.counter }}"
                                   {% if indicator.abc_indicator in request.GET.abc_indicators %}checked{% endif %}
                                   hx-get="{% url 'parts:part_list' %}"
                                   hx-target="#parts-results"
                                   hx-trigger="change"
                                   hx-indicator="#loading-indicator"
                                   hx-include="#filterForm">
                            <label class="form-check-label" for="abc_indicator_{{ forloop.counter }}">
                                {{ indicator.abc_indicator }} ({{ indicator.count }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Weight Range Filter -->
                    <div class="filter-section">
                        <div class="filter-title">
                            <i class="fas fa-weight me-2"></i>Weight Range (kg)
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" 
                                       name="min_weight" placeholder="Min" step="0.01"
                                       value="{{ request.GET.min_weight }}"
                                       hx-get="{% url 'parts:part_list' %}"
                                       hx-target="#parts-results"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-indicator="#loading-indicator"
                                       hx-include="#filterForm">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" 
                                       name="max_weight" placeholder="Max" step="0.01"
                                       value="{{ request.GET.max_weight }}"
                                       hx-get="{% url 'parts:part_list' %}"
                                       hx-target="#parts-results"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-indicator="#loading-indicator"
                                       hx-include="#filterForm">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <a href="{% url 'parts:part_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Reset All Filters
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Parts Grid -->
        <div class="col-lg-9">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="htmx-indicator text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Filtering parts...</p>
            </div>
            
            <div id="parts-results">
                {% if parts %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>{{ parts|length }} Parts Found</h4>
                        <small class="text-muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</small>
                    </div>

                <div class="parts-grid">
                    {% for part in parts %}
                        <div class="part-card">
                            <!-- Stock Badge -->
                            {% if part.quantity > 10 %}
                                <div class="stock-badge in-stock">In Stock</div>
                            {% elif part.quantity > 0 %}
                                <div class="stock-badge low-stock">Low Stock</div>
                            {% else %}
                                <div class="stock-badge out-of-stock">Out of Stock</div>
                            {% endif %}

                            <!-- Sale Badge -->
                            {% if part.is_featured %}
                                <div class="sale-badge">Featured</div>
                            {% endif %}

                            <!-- Part Image -->
                            {% if part.image %}
                                <img src="{{ part.image.url }}" alt="{{ part.name }}" class="part-image">
                            {% elif part.image_url %}
                                <img src="{{ part.image_url }}" alt="{{ part.name }}" class="part-image">
                            {% else %}
                                <div class="part-image d-flex align-items-center justify-content-center bg-light">
                                    <i class="fas fa-cog fa-3x text-muted"></i>
                                </div>
                            {% endif %}

                            <div class="part-content">
                                <a href="{{ part.get_absolute_url }}" class="part-title text-decoration-none">
                                    {{ part.name }}
                                </a>
                                <div class="part-category">{{ part.category.name }} • {{ part.brand.name }}</div>
                                <div class="part-price">${{ part.price }}</div>
                                
                                <!-- Rating Display -->
                                {% if part.average_rating > 0 %}
                                    <div class="mb-2">
                                        <small class="text-warning">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= part.average_rating %}
                                                    ★
                                                {% else %}
                                                    ☆
                                                {% endif %}
                                            {% endfor %}
                                        </small>
                                        <small class="text-muted">({{ part.reviews.count }} reviews)</small>
                                    </div>
                                {% endif %}

                                <div class="part-actions">
                                    {% if part.quantity > 0 %}
                                        <button class="btn-cart btn-secondary-custom pw-add-to-cart-button" 
                                                data-part-id="{{ part.id }}">
                                            Add to Cart
                                        </button>
                                        <button class="btn-cart btn-primary-custom pw-buy-now-button" 
                                                data-part-id="{{ part.id }}">
                                            Buy Now
                                        </button>
                                    {% else %}
                                        <button class="btn-cart btn-secondary-custom" disabled>
                                            Out of Stock
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                    <div class="pagination-custom">
                        <nav aria-label="Parts pagination">
                            <ul class="pagination">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                {% endif %}
                {% else %}
                    <div class="no-parts">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h4>No Parts Found</h4>
                        <p>Try adjusting your search criteria or filters.</p>
                        <a href="{% url 'parts:part_list' %}" class="btn btn-primary">View All Parts</a>
                    </div>
                {% endif %}
            </div> <!-- End parts-results -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="{% static 'js/parts.js' %}"></script>
<script>
// Cart functionality is now handled by parts.js

// Filter functionality
function setPriceRange(min, max) {
    document.querySelector('input[name="min_price"]').value = min;
    document.querySelector('input[name="max_price"]').value = max || '';
    document.getElementById('filterForm').submit();
}

function clearAllFilters() {
    // Clear all form inputs
    const form = document.getElementById('filterForm');
    const inputs = form.querySelectorAll('input[type="checkbox"], input[type="number"], select');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            input.checked = false;
        } else {
            input.value = '';
        }
    });
    form.submit();
}

// Auto-submit filters on change (with debounce for text inputs)
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const checkboxes = filterForm.querySelectorAll('input[type="checkbox"], select');
    const numberInputs = filterForm.querySelectorAll('input[type="number"]');
    
    // Immediate submit for checkboxes and selects
    checkboxes.forEach(input => {
        input.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // Debounced submit for number inputs
    let debounceTimer;
    numberInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                filterForm.submit();
            }, 1000); // Wait 1 second after user stops typing
        });
    });
    
    // Add loading state to filter form
    filterForm.addEventListener('submit', function() {
        const submitBtn = filterForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Filtering...';
            submitBtn.disabled = true;
        }
    });
    
    // Smooth scroll to top when filters change
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('category') || urlParams.has('brand') || urlParams.has('min_price') || urlParams.has('max_price')) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});

// Add filter count badge
function updateFilterCount() {
    const form = document.getElementById('filterForm');
    const activeFilters = form.querySelectorAll('input:checked, input[value]:not([value=""]), select option:checked:not([value=""])').length;
    
    const filterTitle = document.querySelector('.filter-title');
    let badge = filterTitle.querySelector('.filter-count-badge');
    
    if (activeFilters > 0) {
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge bg-primary filter-count-badge ms-2';
            filterTitle.appendChild(badge);
        }
        badge.textContent = activeFilters;
    } else if (badge) {
        badge.remove();
    }
}

// Update filter count on page load and when filters change
document.addEventListener('DOMContentLoaded', updateFilterCount);
</script>
{% endblock %}