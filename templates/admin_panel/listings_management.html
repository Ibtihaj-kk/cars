{% extends 'admin_panel/base.html' %}

{% block title %}Listings Management - Cars Portal Admin{% endblock %}
{% block page_title %}Listings Management{% endblock %}

{% block content %}
<!-- Filters and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Filters & Search</h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ current_filters.search }}" 
                               placeholder="Title, description, or user email">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" 
                                        {% if current_filters.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="make" class="form-label">Make</label>
                        <select class="form-select" id="make" name="make">
                            <option value="">All Makes</option>
                            {% for make in makes %}
                                <option value="{{ make.id }}" 
                                        {% if current_filters.make == make.id|stringformat:"s" %}selected{% endif %}>
                                    {{ make.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="featured" class="form-label">Featured</label>
                        <select class="form-select" id="featured" name="featured">
                            <option value="">All</option>
                            <option value="true" {% if current_filters.featured == 'true' %}selected{% endif %}>
                                Featured Only
                            </option>
                            <option value="false" {% if current_filters.featured == 'false' %}selected{% endif %}>
                                Not Featured
                            </option>
                        </select>
                    </div>
                    
                    <div class="col-md-1">
                        <label for="date_from" class="form-label">From</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ current_filters.date_from }}">
                    </div>
                    
                    <div class="col-md-1">
                        <label for="date_to" class="form-label">To</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ current_filters.date_to }}">
                    </div>
                    
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i>
                        </button>
                        <a href="{% url 'admin_panel:listings_management' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                    Select All
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectNone()">
                    Select None
                </button>
                <span class="text-muted ms-3" id="selectedCount">0 selected</span>
            </div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success btn-sm" onclick="bulkAction('publish')" 
                        id="bulkPublish" disabled>
                    <i class="fas fa-check"></i> Publish
                </button>
                <button type="button" class="btn btn-warning btn-sm" onclick="bulkAction('unpublish')" 
                        id="bulkUnpublish" disabled>
                    <i class="fas fa-pause"></i> Unpublish
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="bulkAction('feature')" 
                        id="bulkFeature" disabled>
                    <i class="fas fa-star"></i> Feature
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="bulkAction('unfeature')" 
                        id="bulkUnfeature" disabled>
                    <i class="fas fa-star-o"></i> Unfeature
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="bulkAction('delete')" 
                        id="bulkDelete" disabled>
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Listings Table -->
<div class="row">
    <div class="col-12">
        <div class="table-container">
            <h5 class="table-header">
                Listings 
                <small class="text-light">({{ page_obj.paginator.count }} total)</small>
            </h5>
            
            {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>Title</th>
                                <th>User</th>
                                <th>Make/Model</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Featured</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for listing in page_obj %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="listing-checkbox" 
                                           value="{{ listing.id }}" onchange="updateBulkActions()">
                                </td>
                                <td>
                                    <a href="{% url 'admin_panel:listing_detail' listing.id %}" 
                                       class="text-decoration-none fw-bold">
                                        {{ listing.title|truncatechars:40 }}
                                    </a>
                                </td>
                                <td>{{ listing.user.email|truncatechars:25 }}</td>
                                <td>
                                    {{ listing.make.name }}
                                    {% if listing.model %}/ {{ listing.model.name }}{% endif %}
                                </td>
                                <td>
                                    {% if listing.price %}
                                        ${{ listing.price|floatformat:0 }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="status-badge status-{{ listing.status }}">
                                        {{ listing.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if listing.is_featured %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-muted"></i>
                                    {% endif %}
                                </td>
                                <td>{{ listing.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'admin_panel:listing_detail' listing.id %}" 
                                           class="btn btn-outline-primary btn-sm" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="quickStatusChange({{ listing.id }}, '{{ listing.status }}')" 
                                                title="Quick Status Change">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="p-3">
                    <nav aria-label="Listings pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            {% else %}
                <div class="p-5 text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No listings found</h5>
                    <p class="text-muted">Try adjusting your filters or search criteria.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Listing Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="statusForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  placeholder="Enter reason for status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedListings = [];
    
    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.listing-checkbox:checked');
        selectedListings = Array.from(checkboxes).map(cb => cb.value);
        
        const count = selectedListings.length;
        document.getElementById('selectedCount').textContent = `${count} selected`;
        
        // Enable/disable bulk action buttons
        const bulkButtons = ['bulkPublish', 'bulkUnpublish', 'bulkFeature', 'bulkUnfeature', 'bulkDelete'];
        bulkButtons.forEach(id => {
            document.getElementById(id).disabled = count === 0;
        });
        
        // Update select all checkbox
        const allCheckboxes = document.querySelectorAll('.listing-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
        selectAllCheckbox.checked = count === allCheckboxes.length;
    }
    
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAllCheckbox').checked;
        document.querySelectorAll('.listing-checkbox').forEach(cb => {
            cb.checked = selectAll;
        });
        updateBulkActions();
    }
    
    function selectAll() {
        document.querySelectorAll('.listing-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateBulkActions();
    }
    
    function selectNone() {
        document.querySelectorAll('.listing-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateBulkActions();
    }
    
    function bulkAction(action) {
        if (selectedListings.length === 0) {
            alert('Please select at least one listing.');
            return;
        }
        
        const actionNames = {
            'publish': 'publish',
            'unpublish': 'unpublish',
            'feature': 'feature',
            'unfeature': 'unfeature',
            'delete': 'delete'
        };
        
        const confirmMessage = `Are you sure you want to ${actionNames[action]} ${selectedListings.length} listing(s)?`;
        
        if (action === 'delete') {
            if (!confirm(confirmMessage + ' This action cannot be undone.')) {
                return;
            }
        } else if (!confirm(confirmMessage)) {
            return;
        }
        
        // Show loading state
        const button = document.getElementById(`bulk${action.charAt(0).toUpperCase() + action.slice(1)}`);
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        button.disabled = true;
        
        fetch('{% url "admin_panel:bulk_update_listings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                action: action,
                listing_ids: selectedListings
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function quickStatusChange(listingId, currentStatus) {
        const modal = new bootstrap.Modal(document.getElementById('statusModal'));
        const form = document.getElementById('statusForm');
        const statusSelect = document.getElementById('newStatus');
        
        // Set form action
        form.action = `/api/admin-panel/listings/${listingId}/update-status/`;
        
        // Set current status as selected
        statusSelect.value = currentStatus;
        
        modal.show();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateBulkActions();
    });
</script>
{% endblock %}